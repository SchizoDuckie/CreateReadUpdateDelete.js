<!doctype html>
<html>
<head>
<title>	CreateReadUpdateDelete.js Demos </title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
<script src="prism.js"></script>
<link rel="stylesheet" href="prism.css" />


<!-- demo scripts -->
<script src='../CRUD.js'></script>
<script src='../CRUD.SqliteAdapter.js'></script>

<script src='Episode.js'></script>
<script src='Season.js'></script>
<script src='Serie.js'></script>
</head>
<body>
<div class="container">
<div class="row">
	<div class="col col-md-12">
		<div class="jumbotron">
		<h1>
			CreateReadUpdateDelete.js
		</h1>
		<p>A tiny Promise-Based WebSQL ORM for Javascript that offers everything you need for 99% of the use cases</p>

		<ul>
		<li>Simple access to WebSQL database rows as if they're plain javascript objects</li>
		<li>A simplified query language, but the freedom to execute plain SQL</li>
		<li>Support for indexes, fixtures and migrations</li>
		<li>Completely promise-based. (Use promise.js for browsers that don't have a native Promise object)
		<li>Built-in caching layer
		</ul>

		<h3>A simple entity</h3>

		<pre><code class="language-js">
/**
 * Create a nice Native function so that we can do console.log and see a Serie object
 */
function Serie() {
    CRUD.Entity.call(this);
}

/**
 * Allow CRUD.js to register itself and the properties defined on each named function.
 */

CRUD.define(Serie, {
    className: 'Serie',
    table: 'Series',
    primary: 'ID_Serie',
    fields: ['ID_Serie', 'name', 'banner', 'overview', 'TVDB_ID', 'actors'],
    autoSerialize: ['actors'],
    relations: {
        'Episode': CRUD.RELATION_FOREIGN,
        'Season': CRUD.RELATION_FOREIGN
    },
    indexes: [
        'fanart',
    ],
    createStatement: 'CREATE TABLE Series (ID_Serie INTEGER PRIMARY KEY NOT NULL, name VARCHAR(250) DEFAULT(NULL), banner VARCHAR(1024) DEFAULT(NULL), overview TEXT DEFAULT(NULL), TVDB_ID INTEGER UNIQUE NOT NULL, actors VARCHAR(1024) DEFAULT(NULL))',
    adapter: 'dbAdapter',
    defaultValues: {},
    fixtures: [],
    migrations: {}
}, {
    getEpisodes: function() {
        return Episode.findBySerie({
            ID_Serie: this.getID()
        }, {
            limit: 100000
        });
    },

    getSeasons: function() {
        return Season.findByID_Serie(this.getID());
    },

    getLastEpisode: function() {
        var filter = ['(Episodes.firstaired > 0 and Episodes.firstAired < ' + new Date().getTime() + ')'];
        filter.ID_Serie = this.getID();
        return CRUD.FindOne('Episode', filter, {
            orderBy: 'seasonnumber desc, episodenumber desc, firstaired desc'
        }).then(function(result) {
            return result;
        });
    }
});
</code></pre>
		
				<h3>Create</h3>

				<pre><code class="language-js">
var serie = new Serie();
serie.name = 'Arrow';
serie.TVDB_ID = '257655';
serie.actors = [
	"Stephen Amell (Oliver Queen / Arrow)",
	"Katie Cassidy (Laurel Lance)",
	"Paul Blackthorne (Detective Quentin Lance)",
	"David Ramsey (John Diggle)",
	"Willa Holland (Thea Queen)",
	"Emily Bett Rickards (Felicity Smoak)",
	"John Barrowman (Malcolm Merlyn)"
];

serie.Persist().then(function(result) {
	console.log("Serie persisted! ", result);
});
</code></pre>

				<h3>Read</h3>
<pre><code class="language-js">
CRUD.Find(Serie, { name: 'Arrow' }).then(function(series) {
	console.log("Found results: ", series);
});
</code></pre>

			
				<h3>Update</h3>
<pre><code class="language-js">
CRUD.FindOne(Serie, {name: 'Arrow'}).then(function(arrow) {
	arrow.overview = [
		"Oliver Queen and his father are lost at sea when their luxury yacht sinks.",
		"His father doesn't survive. Oliver survives on an uncharted island for five years learning to fight,",
		"but also learning about his father's corruption and unscrupulous business dealings.",
		"He returns to civilization a changed man, determined to put things right.",
		"He disguises himself with the hood of one of his mysterious island mentors,",
		"arms himself with a bow and sets about hunting down the men and women who have corrupted his city."
	].join(' ');
	return arrow.Persist();
}).then(function(result) {
	console.log("Arrow update persisted!", result);
})</code></pre>

			

				<h3>Delete</h3>
<pre><code class="language-js">
CRUD.FindOne(Serie, {name: 'Arrow'}).then(function(arrow) {
	return arrow.Delete();
}).then(function(result) {
	console.log("Arrow deleted!");
});
</code></pre>
				<h3>Execute plain SQL</h3>
<pre><code class="language-js">
CRUD.ExecuteQuery("DELETE FROM Series where 1");
</code></pre>

				<h3>Execute custom SQL and 


			</div>
		</div>
	</div>
</div>

<div class="row">
<div class="col col-md-10">
	<h3>Debug info for this page</h3>
	<pre><code id="debugInfo"></code></pre>

</div>
<div class="col col-md-2">
        <button type="button" id='wipe' class="btn btn-warning">Delete all tables and restart</button>
<!-- <p>
        <button type="button" class="btn btn-default">Default</button>
        <button type="button" class="btn btn-primary">Primary</button>
        <button type="button" class="btn btn-success">Success</button>
        <button type="button" class="btn btn-info">Info</button>
        <button type="button" class="btn btn-danger">Danger</button>
        <button type="button" class="btn btn-link">Link</button>
      </p>-->
      </div>
</div>

<script type="text/javascript">

window.onload = function() {

	// enable CRUD Debug mode so that all queries and debug info is appended to the debug info element
	CRUD.DEBUG = true;
	
	function $(id) {
		return  document.getElementById(id);
	}
	
	function $$(selector) {
		return document.querySelectorAll(selector);
	}

	var logElement = $('debugInfo');

	CRUD.log = function() {
        	hasObjects = false;
        	var str = [];
        	for(var i=0; i< arguments.length; i++) {
        		if(typeof(arguments[i]) !== "string") {
        			str.push("\n");
        			str.push(JSON.stringify(arguments[i], null, ' '));
        		} else {
        			str.push(arguments[i]);
        		}
        	}
        	logElement.innerHTML += new Date().getTime()+" CRUD.Log: "+str.join(' ')+"\n";
        
    };

	// Initialize the database with a name and an estimated size
	CRUD.setAdapter(new CRUD.SQLiteAdapter('createreadupdatedelete', {
	    estimatedSize: 25 * 1024 * 1024
	}));

	$('wipe').onclick = function() {
		Promise.all([
			CRUD.executeQuery('DROP TABLE Series'),
			CRUD.executeQuery('DROP TABLE Episodes'),
			CRUD.executeQuery('DROP TABLE Seasons')
		]).then(function() {
			window.location.reload();
		});
	};

};

</script>
</div>

</body>
</html>
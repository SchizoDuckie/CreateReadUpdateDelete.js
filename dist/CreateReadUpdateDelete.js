if(!CRUD)var CRUD={RELATION_SINGLE:1,RELATION_FOREIGN:2,RELATION_MANY:3,RELATION_CUSTOM:4,DEBUG:!1,stats:{writesQueued:0,writesExecuted:0},log:function(){CRUD.DEBUG&&console.log.apply(console,arguments)}};CRUD.EntityManager=function(){this.entities={},this.constructors={},this.cache={},this.connectionAdapter=!1,this.defaultSetup={className:"CRUD.Entity",ID:!1,table:!1,primary:!1,fields:[],indexes:[],autoSerialize:[],defaultValues:{},adapter:!1,orderProperty:!1,orderDirection:!1,relations:{},connectors:{},createStatement:!1,keys:[]};var t=function(t){return t.charAt(0).toUpperCase()+t.slice(1)};return this.registerEntity=function(e,n,i){e.prototype=Object.create(CRUD.Entity.prototype),e.prototype.constructor=CRUD.Entity,n.fields.map(function(t){Object.defineProperty(e.prototype,t,{get:t in i&&"get"in i[t]?i[t].get:function(){return this.get(t)},set:t in i&&"set"in i[t]?i[t].set:function(e){this.set(t,e)},enumerable:!1,configurable:!0})},e);for(var r in i)-1==n.fields.indexOf(r)&&(e.prototype[r]=i[r]);var s=n.className;Object.defineProperty(e.prototype,"__className__",{get:function(){return s},enumerable:!1,configurable:!0}),CRUD.log("Register entity",e,n,s),s in this.entities||(this.entities[s]=Object.clone(this.defaultSetup));for(var a in n)this.entities[s][a]=n[a];return this.constructors[s]=function(t){var n=new e;return t&&n.primaryKeyInit(t),n},e.findByID=function(t){var e={};return e[n.primary]=t,CRUD.FindOne(s,e)},e.Find=function(t,e){return CRUD.Find(s,t,e)},e.FindOne=function(t,e){return CRUD.FindOne(s,t,e)},n.fields.map(function(n){e["findOneBy"+t(n)]=function(t,e){var i={};return i[n]=t,CRUD.FindOne(s,i,e||{})},e["findBy"+t(n)]=function(t,e){var i={};return i[n]=t,CRUD.Find(s,i,e||{})a}}),Object.keys(n.relations).map(function(t){CRUD.log("creating relation search for ",t," to ",s),e["findBy"+t]=function(e){var n={};return n[t]=e,CRUD.Find(s,n)},e["findOneBy"+t]=function(e){var n={};return n[t]=e,CRUD.FindOne(s,n)}}),e},this.getPrimary=function(t){if(!t||!this.entities[t])throw"Invalid className passed to CRUD.EntityManager.getPrimary : "+t;return this.entities[t].primary},this.getDefaultValues=function(t){if(!t||!this.entities[t])throw"Invalid className passed to CRUD.EntityManager.getDefaultValues : "+t;return this.entities[t].defaultValues},this.setAdapter=function(t){return this.connectionAdapter=t,this.connectionAdapter.Init()},this.getAdapter=function(){return this.connectionAdapter},this.getFields=function(t){return this.entities[t].fields},this.hasRelation=function(t,e){return e in this.entities[t].relations},this}(),CRUD.define=function(t,e,n){return CRUD.EntityManager.registerEntity(t,e,n)},CRUD.setAdapter=function(t){return CRUD.EntityManager.setAdapter(t)},CRUD.Find=function(t,e,n){var i=null;if(t instanceof CRUD.Entity||t.prototype instanceof CRUD.Entity)i=t.getType(),t.getID()!==!1&&(CRUD.log("Object has an ID! ",ID,i),e.ID=t.getID(),e.type=e);else{if(!(t in CRUD.EntityManager.entities))throw"CRUD.Find cannot search for non-CRUD objects like "+t+"!";i=t}return CRUD.EntityManager.getAdapter().Find(i,e,n).then(function(t){return t.map(function(t){i in CRUD.EntityManager.cache||(CRUD.EntityManager.cache[i]={});var e=CRUD.EntityManager.entities[i].primary;return t[e]in CRUD.EntityManager.cache[i]||(CRUD.EntityManager.cache[i][t[e]]=new CRUD.EntityManager.constructors[i]),CRUD.EntityManager.cache[i][t[e]].importValues(t)})})},CRUD.FindOne=function(t,e,n){return n=n||{},n.limit=1,this.Find(t,e,n).then(function(t){return t[0]})},CRUD.fromCache=function(t,e){try{t="function"==typeof t?new t:new CRUD.EntityManager.constructors[t],type=t instanceof CRUD.Entity?t.getType():!1}catch(n){return CRUD.log("CRUD.fromCache cannot create for non-CRUD objects like "+t+"! \n"+n),!1}return t.importValues(e,!0),t},CRUD.ConnectionAdapter=function(t,e){return this.endpoint=t||!1,this.options=e||{},this.Init=function(){CRUD.log("The Init method for you connection adapter is not implemented!")},this.Delete=function(){CRUD.log("The Delete method for your connection adaptor is not implemented!")},this.Persist=function(){CRUD.log("The Persist method for your connection adaptor is not implemented!")},this.Find=function(){CRUD.log("The Find method for your connection adaptor is not!")},this},CRUD.Entity=function(){return this.__values__={},this.__dirtyValues__={},this},CRUD.Entity.prototype={getID:function(){return this.get(CRUD.EntityManager.getPrimary(this.getType()))||!1},asObject:function(){return this.__values__},Find:function(t,e,n){return n=n||{},e=e||{},e[this.getType()]={},e[this.getType()][CRUD.EntityManager.getPrimary(this.getType())]=this.getID(),CRUD.Find(t,e,n)},getValues:function(){var t=this.__values__;if(this.____dirtyValues____&&Array.from(this.____dirtyValues____).length>0)for(var e in this.__dirtyValues__)t[e]=this.__dirtyValues__[e];return t.ID=this.getID(),t},importValues:function(t,e){for(var n in t)this.__values__[n]=CRUD.EntityManager.entities[this.getType()].autoSerialize.indexOf(n)>-1?JSON.parse(t[n]):t[n];return e&&(this.__dirtyValues__=this.__values__,this.__values__={}),this},get:function(t){var e;return t in this.__dirtyValues__?e=this.__dirtyValues__[t]:t in this.__values__?e=this.__values__[t]:CRUD.log("Could not find field '"+t+"' in '"+this.getType()+"' (for get)"),e},set:function(t,e){t in this?this.get(t)===e||[null,void 0].indexOf(this.get(t))>-1&&[null,void 0].indexOf(e)>-1||(CRUD.EntityManager.entities[this.getType()].autoSerialize.indexOf(t)>-1?JSON.stringify(this.get(t))!=JSON.stringify(e)&&(this.__dirtyValues__[t]=e):this.__dirtyValues__[t]=e):CRUD.log("Could not find field '"+t+"' in '"+this.getType()+"' (for set)")},Persist:function(t){var e=this,n=this.getType();return new Promise(function(i,r){if(!t&&0==Object.keys(e.__dirtyValues__).length)return i();if(e.get(CRUD.EntityManager.getPrimary(e.getType()))===!1||t){var s=CRUD.EntityManager.entities[e.getType()].defaultValues;if(Object.keys(s).length>0)for(var a in s)a in e&&!e.__dirtyValues__[a]&&(e.__dirtyValues__[a]=s[a])}return CRUD.EntityManager.getAdapter().Persist(e,t).then(function(t){CRUD.log(e.getType()+" has been persisted. Result: "+t.Action+". New Values: "+JSON.stringify(e.__dirtyValues__)),"inserted"==t.Action&&(e.__dirtyValues__[CRUD.EntityManager.getPrimary(n)]=t.ID,n in CRUD.EntityManager.cache||(CRUD.EntityManager.cache[n]={}),CRUD.EntityManager.cache[n][t.ID]=e);for(var r in e.__dirtyValues__)e.__values__[r]=e.__dirtyValues__[r];e.__dirtyValues__={},e.ID=e.__values__[CRUD.EntityManager.getPrimary(n)],i(t)},function(t){CRUD.log("Error saving CRUD",e,t),r(t)})})},Delete:function(){var t=this;return CRUD.EntityManager.getAdapter().Delete(t).then(function(e){return"deleted"==e.Action&&(CRUD.log(t.getType()+" "+t.getID()+" has been deleted! "),delete CRUD.EntityManager.cache[t.getType()][t.getID()],t.__values__[CRUD.EntityManager.getPrimary(t.getType())].ID=!1),e})},getType:function(){return this.__className__},Connect:function(t){var e=t.getType(),n=(this.getType(),this.dbSetup.primary),i=t.dbSetup.primary,r=this;new Promise(function(s,a){Promise.all([r.Persist(),t.Persist()]).then(function(){switch(r.dbSetup.relations[e]){case CRUD.RELATION_SINGLE:t.set(n,r.getID()),r.set(i,t.getID());break;case CRUD.RELATION_FOREIGN:n in t&&t.set(n,r.getID()),i in r&&r.set(i,t.getID());break;case CRUD.RELATION_MANY:var o=new window[r.dbSetup.connectors[e]];return o.set(n,r.getID()),o.set(i,t.getID()),void o.Persist().then(s,a);case CRUD.RELATION_CUSTOM:}r.dbSetup.relations[t.getType()]!=CRUD.RELATION_MANY&&Promise.all([t.Persist(),from.Persist()]).then(s,a)},a)})},Disconnect:function(t){var e=t.getType(),n=(this.getType(),CRUD.EntityManager.getPrimary(this)),i=CRUD.Entitymanager.getPrimary(t),r=this;new Promise(function(s,a){Promise.all([r.Persist(),t.Persist()]).then(function(){switch(this.dbSetup.relations[t.getType()]){case CRUD.RELATION_SINGLE:t.set(n,null),r.set(i,null);break;case CRUD.RELATION_FOREIGN:n in t&&t.set(n,null),i in r&&r.set(i,null);break;case CRUD.RELATION_MANY:var o={};return o[n]=this.getID(),o[i]=t.getID(),void CRUD.FindOne(this.dbSetup.connectors[e],o).then(function(t){t.Delete().then(s,a)},a);case CRUD.RELATION_CUSTOM:}Promise.all([r.Persist(),this.Persist()]).then(s,a)},a)})},primaryKeyInit:function(t){return this.ID=t||!1,this.ID!==!1?this.Find({ID:t}):void 0}},"clone"in Object||(Object.clone=function(t){return JSON.parse(JSON.stringify(t))}),CRUD.executeQuery=function(t,e){return CRUD.EntityManager.getAdapter().db.execute(t,e||[])},CRUD.SQLiteAdapter=function(t,e){function n(t){return CRUD.stats.writesExecuted++,t.Action="updated",t}function i(t){console.error("Update query error!",t),CRUD.stats.writesExecuted++}function r(t){return t.Action="inserted",t.ID=t.rs.insertId,CRUD.stats.writesExecuted++,t}function s(t){return CRUD.stats.writesExecuted++,console.error("Insert query error: ",t),t}this.databaseName=t,this.dbOptions=e,this.lastQuery=!1,this.initializing=!0,CRUD.ConnectionAdapter.apply(this,arguments);var a,o=this;this.Init=function(){return this.db=a=new CRUD.Database(o.databaseName),a.connect().then(function(){return CRUD.log("SQLITE connection created to ",o.databaseName),u().then(function(){o.initializing=!1})})};var u=function(){CRUD.log("verifying that tables exist");var t=[],e={};return a.execute("select type,name,tbl_name from sqlite_master").then(function(n){for(var i=0;i<n.rs.rows.length;i++){var r=n.rs.rows.item(i);r.name.indexOf("sqlite_autoindex")>-1||"__WebKitDatabaseInfoTable__"==r.name||("table"==r.type?t.push(r.tbl_name):"index"==r.type&&(r.tbl_name in e||(e[r.tbl_name]=[]),e[r.tbl_name].push(r.name)))}}).then(function(){return Promise.all(Object.keys(CRUD.EntityManager.entities).map(function(e){var n=CRUD.EntityManager.entities[e];if(-1==t.indexOf(n.table)){if(!n.createStatement)throw"No create statement found for "+n.className+". Don't know how to create table.";return a.execute(n.createStatement).then(function(){return t.push(n.table),localStorage.setItem("database.version."+n.table,"migrations"in n?Math.max.apply(Math,Object.keys(n.migrations)):1),CRUD.log(n.className+" table created."),n},function(t){throw CRUD.log("Error creating "+n.className,t),"Error creating table: "+n.table+" for "+n.className}).then(l).then(function(){CRUD.log("Table created and fixtures inserted for ",n.className)})}}))}).then(function(){return Promise.all(Object.keys(CRUD.EntityManager.entities).map(function(t){var e=CRUD.EntityManager.entities[t];if(e.migrations){var n=localStorage.getItem("database.version."+e.table)?parseInt(localStorage.getItem("database.version."+e.table),10):1;isNaN(n)&&(n=1);var i=Math.max.apply(Math,Object.keys(e.migrations));if(n==i)return;return Promise.all(Object.keys(e.migrations).map(function(i){return parseInt(i)>n?Promise.all(e.migrations[i].map(function(e){return CRUD.log("Executing migration: ",e),a.execute(e).then(function(t){return CRUD.log("Migration success!",t),!0},function(){throw"Migration "+i+" failed for entity "+t})})).then(function(){return CRUD.log("All migrations executed for version ",i),localStorage.setItem("database.version."+e.table,i),!0}):!0}))}}))}).then(function(){return Promise.all(Object.keys(CRUD.EntityManager.entities).map(function(t){var n=CRUD.EntityManager.entities[t];return"indexes"in n?Promise.all(n.indexes.map(function(t){var i=t.replace(/\W/g,"")+"_idx";return n.table in e&&-1!=e[n.table].indexOf(i)?void 0:a.execute("create index if not exists "+i+" on "+n.table+" ("+t+")").then(function(){CRUD.log("index created: ",n.table,t,i),n.table in e||(e[n.table]=[]),e[n.table].push(i)})})):void 0}))}).then(function(){CRUD.log("All migrations are done!"),o.initializing=!1})},l=function(t){return new Promise(function(e,n){return t.fixtures?Promise.all(t.fixtures.map(function(e){CRUD.fromCache(t.className,e).Persist(!0)})).then(e,n):e()})},c=function(t){return o.initializing?void setTimeout(c,50,t):t()};return this.Find=function(t,e,n){var i=new CRUD.Database.SQLBuilder(t,e,n),r=i.buildQuery();return CRUD.log("Executing query via sqliteadapter: ",n,r),new Promise(function(t,e){return c(function(){a.execute(r.query,r.parameters).then(function(e){for(var n=[],i=0;i<e.rs.rows.length;i++)n.push(e.rs.rows.item(i));t(n)},function(t,n){CRUD.log("SQL Error in FIND : ",n,t,r),e()})})})},this.Persist=function(t,e){function o(e){f.push(e),h.push("?"),g.push(t.__dirtyValues__[e])}function u(e){e in t.__dirtyValues__||e in t.__values__||(f.push(e),h.push("?"),g.push(CRUD.EntityManager.entities[t.getType()].defaultValues[e]))}function l(t){f.indexOf(t)>-1&&(g[f.indexOf(t)]=JSON.stringify(g[f.indexOf(t)]))}CRUD.stats.writesQueued++;var c=[],h=[],g=[],f=[];return Object.keys(t.__dirtyValues__).map(o),Object.keys(CRUD.EntityManager.entities[t.getType()].defaultValues).map(u),CRUD.EntityManager.entities[t.getType()].autoSerialize.map(l),t.getID()===!1||void 0===t.getID()||e?(c.push("INSERT INTO ",CRUD.EntityManager.entities[t.getType()].table,"(",f.join(","),") VALUES (",h.join(","),");"),CRUD.log(c.join(" "),g),a.execute(c.join(" "),g).then(r,s)):(c.push("UPDATE",CRUD.EntityManager.entities[t.getType()].table,"SET",f.map(function(t){return t+" = ?"}).join(",")),g.push(t.getID()),c.push("WHERE",CRUD.EntityManager.getPrimary(t.getType()),"= ?"),a.execute(c.join(" "),g).then(n,i))},this.Delete=function(t){return t.getID()!==!1?(query=["delete from",CRUD.EntityManager.entities[t.getType()].table,"where",CRUD.EntityManager.getPrimary(t.getType()),"= ?"].join(" "),a.execute(query,[t.getID()]).then(function(t){return t.Action="deleted",t},function(t){throw CRUD.log("error deleting element from db: ",t),t})):!1},this},CRUD.Database=function(t,e){function n(){a.length>0&&r.transaction(function(t){var e=a.splice(0,25);0!==e.length&&e.map(function(e){function n(t,n){e.resolve(new CRUD.Database.ResultSet(n))}function i(t,n){CRUD.log("SQL FAIL!!",n,t),e.fail(n,t)}t.executeSql(e.sql,e.valueBindings,n,i),CRUD.DEBUG&&CRUD.log(e.sql,e.valueBindings)})})}e=e||{version:"1.0",estimatedSize:655360};var i=0,r=!1,s=t||!1;this.lastInsertId=function(){return i},this.close=function(){return r.close()},this.getDB=function(){return r};var a=[];this.execute=function(t,e){return r?new Promise(function(i,r){a[0===t.indexOf("SELECT")?"unshift":"push"]({sql:t,valueBindings:e,resolve:i,fail:r}),setTimeout(n,10)}):void 0},this.connect=function(){return new Promise(function(t,n){try{r=openDatabase(s,e.version,"",e.estimatedSize),r?(CRUD.log("DB connection to ",s," opened!"),t(this)):n("could not open database "+s)}catch(i){CRUD.log("DB ERROR "+i.toString()),n("ERROR!"+i.toString(),i)}})}},CRUD.Database.ResultSet=function(t){return this.rs=t,this.index=0,this},CRUD.Database.ResultSet.prototype.next=function(){var t=null;return this.index<this.rs.rows.length&&(t=new CRUD.Database.ResultSet.Row(this.rs.rows.item(this.index++))),t},CRUD.Database.ResultSet.Row=function(t){return this.row=t,this},CRUD.Database.ResultSet.Row.prototype.get=function(t,e){var n=this.row[t];return n?n:e},CRUD.Database.SQLBuilder=function(t,e,n){this.entity=t instanceof CRUD.Entity?t.getType():t,this.entityConfig=CRUD.EntityManager.entities[this.entity],this.filters=e||{},this.options=n||{},this.justthese=[],this.wheres=[],this.joins=[],this.fields=[],this.orders=[],this.groups=[],this.parameters=[],Object.keys(this.filters).map(function(t){this.buildFilters(t,this.filters[t],this.entity)},this),this.options.orderBy?this.orders.push(this.prefixFieldNames(this.options.orderBy.replace("ORDER BY",""))):this.entityConfig.orderProperty&&this.entityConfig.orderDirection&&0===this.orders.length&&this.orders.push(this.getFieldName(this.entityConfig.orderProperty)+" "+this.entityConfig.orderDirection),this.options.groupBy&&this.groups.push(this.options.groupBy.replace("GROUP BY","")),this.limit=this.options.limit?"LIMIT "+n.limit:"LIMIT 0,1000",(this.options.justthese||CRUD.EntityManager.entities[this.entity].fields).map(function(t){this.fields.push(this.getFieldName(t))},this)},CRUD.Database.SQLBuilder.prototype={getFieldName:function(t,e){return(e||this.entityConfig.table)+"."+t},prefixFieldNames:function(t){var e=t.split(",");return e.map(function(t){var e=t.trim().split(" "),n=e[1].toUpperCase().match(/(ASC|DESC)/)[0];return t=e[0],this.entityConfig.fields.indexOf(t)>-1&&(t=this.getFieldName(t)),t+" "+n},this).join(", ")},buildFilters:function(t,e,n){var i=CRUD.EntityManager.hasRelation(n,t);if(i)for(var r in e)this.buildFilters(r,e[r],t),this.buildJoins(n,t);else isNaN(parseInt(t,10))?("ID"==t&&(t=CRUD.EntityManager.getPrimary(n)),this.wheres.push(this.getFieldName(t,CRUD.EntityManager.entities[n].table)+" = ?"),this.parameters.push(e)):this.wheres.push(e)},buildJoins:function(t,e){if(e){var n=CRUD.EntityManager.entities[t];switch(e=CRUD.EntityManager.entities[e],e.relations[n.className]){case CRUD.RELATION_SINGLE:case CRUD.RELATION_FOREIGN:n.fields.indexOf(e.primary)>-1?this.addJoin(e,n,e.primary):e.fields.indexOf(n.primary)>-1&&this.addJoin(e,n,n.primary);break;case CRUD.RELATION_MANY:connectorClass=e.connectors[n.getType()],conn=CRUD.EntityManager.entities[connectorClass],this.addJoin(conn,n,n.primary).addJoin(e,conn,e.primary);break;case CRUD.RELATION_CUSTOM:var i=e.relations[n.getType()];this.joins=this.joins.unshift(["LEFT JOIN",n.table,"ON",this.getFieldName(i.sourceProperty,e.table),"=",this.getFieldName(i.targetProperty,n.table)].join(" "));break;default:throw new Exception("Warning! class "+e.getType()+" probably has no relation defined for class "+n.getType()+"  or you did something terribly wrong..."+JSON.encode(e.relations[_class]))}}},addJoin:function(t,e,n,i){var r=["LEFT JOIN",t.table,"ON",this.getFieldName(n,e.table),"=",this.getFieldName(i||n,t.table)].join(" ");return-1==this.joins.indexOf(r)&&this.joins.push(r),this},buildQuery:function(){var t=this.wheres.length>0?" WHERE "+this.wheres.join(" \n AND \n	"):"",e=this.orders.length>0?" ORDER BY "+this.orders.join(", "):"",n=this.groups.length>0?" GROUP BY "+this.groups.join(", "):"",i="SELECT "+this.fields.join(", \n	")+"\n FROM \n	"+CRUD.EntityManager.entities[this.entity].table+"\n "+this.joins.join("\n ")+t+" "+n+" "+e+" "+this.limit;return{query:i,parameters:this.parameters}},getCount:function(){var t=this.wheres.length>0?" WHERE "+this.wheres.join(" \n AND \n	"):"",e=this.groups.length>0?" GROUP BY "+this.groups.join(", "):"",n="SELECT count(*) FROM \n	"+CRUD.EntityManager.entities[this.entity].table+"\n "+this.joins.join("\n ")+t+" "+e;return n}};
